# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: "Build server (CMake)"

on:
  push:
    branches:
    - master

    paths:
      - '.github/workflows/build_cmake_server.yml'
      - 'CMakeLists.txt'
      - 'deps/asio-cmake/CMakeLists.txt'
      - 'deps/boost-cmake/CMakeLists.txt'
      - 'deps/db-library-cmake/CMakeLists.txt'
      - 'deps/db-models-cmake/CMakeLists.txt'
      - 'deps/djb2-cmake/CMakeLists.txt'
      - 'deps/FTXUI-cmake/CMakeLists.txt'
      - 'deps/nanodbc-cmake/CMakeLists.txt'
      - 'deps/spdlog-cmake/CMakeLists.txt'
      - 'Server/**/CMakeLists.txt'
      - 'Server/**/.cpp'
      - 'Server/**/.h'
      - 'shared/CMakeLists.txt'
      - 'shared/**/.cpp'
      - 'shared/**/.h'

  pull_request:
    branches:
    - master

    paths:
      - '.github/workflows/build_cmake_server.yml'
      - 'CMakeLists.txt'
      - 'deps/asio-cmake/CMakeLists.txt'
      - 'deps/boost-cmake/CMakeLists.txt'
      - 'deps/db-library-cmake/CMakeLists.txt'
      - 'deps/db-models-cmake/CMakeLists.txt'
      - 'deps/djb2-cmake/CMakeLists.txt'
      - 'deps/FTXUI-cmake/CMakeLists.txt'
      - 'deps/nanodbc-cmake/CMakeLists.txt'
      - 'deps/spdlog-cmake/CMakeLists.txt'
      - 'Server/**/CMakeLists.txt'
      - 'Server/**/.cpp'
      - 'Server/**/.h'
      - 'shared/CMakeLists.txt'
      - 'shared/**/.cpp'
      - 'shared/**/.h'

  workflow_dispatch:

env:
  CLANG_LATEST_VERSION: 20

jobs:
  build_windows:
    runs-on: windows-latest

    strategy:
      matrix:
        BUILD_CONFIGURATION: [Debug, Release]
        BUILD_PLATFORM: [Win32, x64]

    name: "Server: ${{ matrix.BUILD_CONFIGURATION }} - ${{ matrix.BUILD_PLATFORM }} (Windows)"

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'false'

    - uses: lukka/get-cmake@latest

    - name: Configure CMake
      shell: bash
      run: |
        cmake -S . \
          -B build-windows-${{ matrix.BUILD_CONFIGURATION }}-${{ matrix.BUILD_PLATFORM }} \
          -G "Visual Studio 17 2022" \
          -A ${{ matrix.BUILD_PLATFORM }} \
          -DCMAKE_BUILD_TYPE=${{ matrix.BUILD_CONFIGURATION }}

    - name: Build server
      shell: bash
      run: |
        cmake \
          --build build-windows-${{ matrix.BUILD_CONFIGURATION }}-${{ matrix.BUILD_PLATFORM }} \
          --config ${{ matrix.BUILD_CONFIGURATION }}

    - name: Run tests
      shell: bash
      working-directory: build-windows-${{ matrix.BUILD_CONFIGURATION }}-${{ matrix.BUILD_PLATFORM }}
      run: |
        ctest -C "${{ matrix.BUILD_CONFIGURATION }}" --verbose

  build_linux:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        BUILD_CONFIGURATION: [Debug, Release]
        COMPILER: [gcc, clang, clang-latest]

    name: "Server: ${{ matrix.BUILD_CONFIGURATION }} - ${{ matrix.COMPILER }} (Linux - Ubuntu)"

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'false'

      - name: Install unixODBC
        run: sudo apt-get install unixodbc-dev -y

      - uses: lukka/get-cmake@latest

      - name: Setup compiler
        run: |
          if [ "${{ matrix.COMPILER }}" = "gcc" ]; then
            export CC=gcc
            export CXX=g++
          elif [ "${{ matrix.COMPILER }}" = "clang" ]; then
            export CC=clang
            export CXX=clang++
          else
            wget https://apt.llvm.org/llvm.sh
            chmod +x llvm.sh
            sudo ./llvm.sh ${{ env.CLANG_LATEST_VERSION }}
            sudo apt-get update          
            export CC=clang-${{ env.CLANG_LATEST_VERSION }}
            export CXX=clang++-${{ env.CLANG_LATEST_VERSION }}
          fi
          echo "CC=$CC" >> $GITHUB_ENV
          echo "CXX=$CXX" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          cmake -S . \
            -B build-${{ matrix.COMPILER }}-${{ matrix.BUILD_CONFIGURATION }} \
            -G "Ninja" \
            -DCMAKE_BUILD_TYPE=${{ matrix.BUILD_CONFIGURATION }}

      - name: Build server
        run: |
          cmake \
            --build build-${{ matrix.COMPILER }}-${{ matrix.BUILD_CONFIGURATION }} \
            --config ${{ matrix.BUILD_CONFIGURATION }}

      - name: Run tests
        shell: bash
        working-directory: build-${{ matrix.COMPILER }}-${{ matrix.BUILD_CONFIGURATION }}
        run: |
          ctest -C "${{ matrix.BUILD_CONFIGURATION }}" --verbose

  build_macos:
    runs-on: macos-latest

    strategy:
      matrix:
        BUILD_CONFIGURATION: [Debug, Release]
        COMPILER: [XCode]

    name: "Server: ${{ matrix.BUILD_CONFIGURATION }} - ${{ matrix.COMPILER }} (MacOS)"

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'false'

      - name: Install unixODBC
        run: brew install unixodbc

      - uses: lukka/get-cmake@latest

      - name: Setup compiler
        run: |
          export CC=clang
          export CXX=clang++

      - name: Configure CMake
        run: |
          cmake -S . \
            -B build-${{ matrix.COMPILER }}-${{ matrix.BUILD_CONFIGURATION }} \
            -G "Ninja" \
            -DCMAKE_BUILD_TYPE=${{ matrix.BUILD_CONFIGURATION }}

      - name: Build server
        run: |
          cmake \
            --build build-${{ matrix.COMPILER }}-${{ matrix.BUILD_CONFIGURATION }} \
            --config ${{ matrix.BUILD_CONFIGURATION }}

      - name: Run tests
        shell: bash
        working-directory: build-${{ matrix.COMPILER }}-${{ matrix.BUILD_CONFIGURATION }}
        run: |
          ctest -C "${{ matrix.BUILD_CONFIGURATION }}" --verbose
